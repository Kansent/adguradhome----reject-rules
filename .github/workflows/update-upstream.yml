name: Update upstream domains

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # âœ… ç¡®ä¿å®Œæ•´æ‹‰å–ä»“åº“
      - run: ls -R        # ðŸ§© åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼Œç¡®è®¤ merge_upstream.py å­˜åœ¨
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - run: pip install requests
      - run: python merge_upstream.py
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ ! -f output/nextdns-native-tracking-domains.txt ]; then
            echo "âŒ Error: output file not found"
            exit 1
          fi

          git checkout --orphan release-upstream
          git rm -rf . > /dev/null 2>&1 || true
          cp output/nextdns-native-tracking-domains.txt ./nextdns-native-tracking-domains.txt
          git add nextdns-native-tracking-domains.txt
          git commit -m "Auto update upstream domains [skip ci]"
          git push origin release-upstream --force
